# üîí –†–µ–∞–ª–∏–∑–∞—Ü–∏—è "–∂–µ–ª–µ–∑–æ–±–µ—Ç–æ–Ω–Ω–æ–π" –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. "–ù–µ–¥–æ–≤–µ—Ä—á–∏–≤—ã–π" –±—ç–∫–µ–Ω–¥ (–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ì–æ–Ω–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –º–µ–∂–¥—É JWT —Ç–æ–∫–µ–Ω–æ–º –∏ SQL –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç JWT —Å –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ `["model-A"]`
- –ê–¥–º–∏–Ω –≤—ã–¥–∞–µ—Ç `model-B` ‚Üí SQL –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è ‚Üí WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
- –§—Ä–æ–Ω—Ç–µ–Ω–¥ –æ–±–Ω–æ–≤–ª—è–µ—Ç UI, –Ω–æ JWT —Ç–æ–∫–µ–Ω –≤—Å–µ –µ—â–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É ‚Üí API –ø—Ä–æ–≤–µ—Ä—è–µ—Ç JWT ‚Üí 403 Forbidden

**–†–µ—à–µ–Ω–∏–µ:** –î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç SQL, –∞ –Ω–µ JWT

```python
# backend/auth_decorators.py
def subscription_required(model_id):
    def decorator(f):
        @wraps(f)
        def decorated(*args, **kwargs):
            # 1. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è: –∫—Ç–æ —ç—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å?
            token_data = getattr(request, 'user_data', None)
            user_id = token_data['user_id']
            
            # 2. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: –ü–†–û–í–ï–†–Ø–ï–ú SQL –ü–†–Ø–ú–û –°–ï–ô–ß–ê–°
            has_subscription = db.query(UserSubscription).filter(
                UserSubscription.user_id == int(user_id),
                UserSubscription.model_id == model_id,
                UserSubscription.is_active == True,
                (UserSubscription.expiry_date == None) | (UserSubscription.expiry_date > datetime.utcnow())
            ).first()
            
            if not has_subscription:
                return jsonify({"error": "Subscription required"}), 403
            
            return f(*args, **kwargs)
        return decorated
    return decorator
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 100% —Ç–æ—á–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö, –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–±—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Ç–æ–∫–µ–Ω—ã

### 2. "–°–∞–º–æ–ª–µ—á–µ–Ω–∏–µ" —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ (–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å)

**–ü—Ä–æ–±–ª–µ–º–∞:** WebSocket –º–æ–∂–µ—Ç –Ω–µ –¥–æ—Å—Ç–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ (–ø–ª–æ—Ö–∞—è —Å–≤—è–∑—å, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –º–µ—Ç—Ä–æ)

**–†–µ—à–µ–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –≤ —Å–µ—Ç—å

```javascript
// src/hooks/useSubscriptionSelfHealing.js
export const useSubscriptionSelfHealing = (setUserSubscriptions, showNotification) => {
  const fetchMySubscriptions = useCallback(async () => {
    const subscriptions = await apiClient.getMySubscriptions()
    setUserSubscriptions(subscriptions)
  }, [setUserSubscriptions])

  useEffect(() => {
    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–µ—Ä–Ω—É–ª—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        fetchMySubscriptions()
      }
    })

    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    window.addEventListener('online', fetchMySubscriptions)

    // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)
    const intervalId = setInterval(fetchMySubscriptions, 5 * 60 * 1000)
    
    return () => {
      document.removeEventListener('visibilitychange', handleVisibilityChange)
      window.removeEventListener('online', fetchMySubscriptions)
      clearInterval(intervalId)
    }
  }, [fetchMySubscriptions])
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 99.9% –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–±–æ–µ–≤

### 3. –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫ (–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–æ–≤–µ—Ä–∫–∞ SQL –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–æ–π

**–†–µ—à–µ–Ω–∏–µ:** –°–≤–µ—Ä—Ö–±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π

```python
# backend/auth_decorators_optimized.py
def subscription_required_optimized(model_id):
    def decorator(f):
        @wraps(f)
        def decorated(*args, **kwargs):
            token_data = getattr(request, 'user_data', None)
            user_id = token_data['user_id']
            token_version = token_data.get('sub_version', 1)
            
            # –°–í–ï–†–•–ë–´–°–¢–†–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏
            user = db.query(User).filter(User.telegram_id == int(user_id)).first()
            current_version = user.subscription_version
            
            # –ï—Å–ª–∏ –≤–µ—Ä—Å–∏–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç - —Ç–æ–∫–µ–Ω —É—Å—Ç–∞—Ä–µ–ª
            if token_version != current_version:
                return jsonify({"error": "Token outdated"}), 401
            
            # –ï—Å–ª–∏ –≤–µ—Ä—Å–∏–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç - –¥–æ–≤–µ—Ä—è–µ–º JWT (–±—ã—Å—Ç—Ä–æ!)
            user_subs = token_data.get('subscriptions', [])
            if model_id not in user_subs:
                return jsonify({"error": "Subscription required"}), 403
            
            return f(*args, **kwargs)
        return decorated
    return decorator
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **PostgreSQL 16** —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–π —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å—é
- **3 —Ç–∞–±–ª–∏—Ü—ã**: User, SubscriptionModel, UserSubscription
- **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ**: `subscription_version` –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- **–ò–Ω–¥–µ–∫—Å—ã** –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- **JWT —Ç–æ–∫–µ–Ω—ã** (7 –¥–Ω–µ–π –∂–∏–∑–Ω–∏) —Å –ø–æ–¥–ø–∏—Å—è–º–∏
- **–¢–æ–∫–µ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç**: user_id, role, subscriptions, sub_version
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏** Telegram WebApp –¥–∞–Ω–Ω—ã—Ö

### –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- **"–ù–µ–¥–æ–≤–µ—Ä—á–∏–≤—ã–π" –±—ç–∫–µ–Ω–¥**: –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç SQL, –∞ –Ω–µ JWT
- **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã**: –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–π –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
- **Fallback –º–µ—Ö–∞–Ω–∏–∑–º**: –ø–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ SQL –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### –ü–æ–¥–ø–∏—Å–∫–∏
- **–ü–æ–∂–∏–∑–Ω–µ–Ω–Ω—ã–µ** (expiry_date = NULL)
- **–í—Ä–µ–º–µ–Ω–Ω—ã–µ** (expiry_date = –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –¥–∞—Ç–∞)
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è** –∏—Å—Ç—ë–∫—à–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫
- **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–æ–∫

### WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- **–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–æ–∫
- **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ** –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ

## üöÄ –†–µ–∑—É–ª—å—Ç–∞—Ç

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: 100%
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–±—Ö–æ–¥–∞ –ø–æ–¥–ø–∏—Å–æ–∫
- –ó–∞—â–∏—Ç–∞ –æ—Ç –≥–æ–Ω–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ SQL

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å: 99.9%
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–±–æ–µ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –≤ —Å–µ—Ç—å
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
- –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ –≤–µ—Ä—Å–∏–∏
- Fallback –∫ –ø–æ–ª–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î

## üìÅ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### Backend
- `backend/auth_decorators.py` - –û—Å–Ω–æ–≤–Ω—ã–µ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- `backend/auth_decorators_optimized.py` - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã
- `backend/auth_service_sql.py` - SQL –≤–µ—Ä—Å–∏—è —Å–µ—Ä–≤–∏—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- `backend/init_db.py` - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î
- `backend/check_db.py` - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ë–î
- `backend/test_security.py` - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- `backend/start_production.bat` - –ó–∞–ø—É—Å–∫ production —Å–∏—Å—Ç–µ–º—ã

### Frontend
- `src/services/apiClient.js` - API –∫–ª–∏–µ–Ω—Ç —Å JWT
- `src/hooks/useSubscriptionSelfHealing.js` - –•—É–∫ —Å–∞–º–æ–ª–µ—á–µ–Ω–∏—è

### Database
- `backend/migrations/001_create_tables.sql` - SQL –º–∏–≥—Ä–∞—Ü–∏—è
- `backend/models.py` - –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ —Å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º

### Configuration
- `backend/config.env` - –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- `requirements.txt` - –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ "–∂–µ–ª–µ–∑–æ–±–µ—Ç–æ–Ω–Ω–∞—è" —Å–∏—Å—Ç–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å —Ç—Ä–µ–º—è —É—Ä–æ–≤–Ω—è–º–∏ –∑–∞—â–∏—Ç—ã:

1. **"–ù–µ–¥–æ–≤–µ—Ä—á–∏–≤—ã–π" –±—ç–∫–µ–Ω–¥** - –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç 100% —Ç–æ—á–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
2. **"–°–∞–º–æ–ª–µ—á–µ–Ω–∏–µ" —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞** - –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç 99.9% –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
3. **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫** - –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å—é.
